Mongo Shared Cluster
--------------------

mongosh (mongo shell) is the new mongo command and can be installe on a Mac via

```bash
# MacOS
brew install mongosh
```

It can be used to connect to the cluster via `mongosh mongodb://127.0.0.1:27017` as soon as it is running and
configured.

To keep the scripts consistent the `start.sh` script sets the docker-compose project name to msc which will prefix all
containers with msc_.

All instances share a keyfile that needs to be generated by running `./genKeyfile.sh` before starting the cluster.

You can start the whole cluster via `./start.sh`. Be careful using `./restart.sh` because it will prune your whole
docker environment (by using `./prune.sh`).

Check the `start.sh` script and the called scripts for further details. In general first the containers are created and
then a setup process is done where the following steps are followed:
 - create configuration replica set (`setup_configsvr.sh`)
 - create shard0 and shard1 (`setup_shard.sh`)
 - add shards to cluster (`setup_mongos.sh`)

Default credentials: admin / admin123

# Enable sharding for database and enable sharding for collection

```bash
mongosh mongodb://127.0.0.1:27017
```

```js
db.getSiblingDB("admin").auth("admin", "admin123")
use demodb
sh.enableSharding("demodb")

sh.shardCollection("demodb.users", {"email": "hashed"})
db.users.createIndex({"email": 1}, {unique: true})
db.users.getShardDistribution()
```

## Noted useful commands

```
// show databases
show dbs

// show active db
db

// switch to another db
use <dbname>

show collections

// create new collection
db.createCollection("<name>")

// enable sharding for db - just allows sharding for single collections - this isn't global
sh.enableSharding("<dbname>")

// shard a collection - shardkey is used to select shard and it needs a type - example uses title field with hash key
sh.shardCollection("<dbname>.<collectionName>", {"title": "hashed"})

// see sharding info
db.<collectionName>.getShardDistribution()

// list records
db.<collectionName>.find()

// create index for existing table
db.<collectionName>.createIndex({"title": "hashed"})
```